<!DOCTYPE html>
<html>
<head>
<!-- Article ID: 48 - Extracted from develop-1996 -->
<!-- on 2025-01-18 by Giorgio Ferrara - giorgio<dot>ferrara<at>gmail<dot>com -->
<!-- The content is protected by the copyright of its respective owners -->
<title>September 96 - KON & BAL's Puzzle Page: QuickTime Quandary</title>
<link href="../common/styles/main.css" rel="stylesheet" type="text/css">
</head>
<body>
<h1>KON &amp; BAL's Puzzle Page: QuickTime Quandary</h1>
<h2>Konstantin Othmer and Bruce Leak</h2>
<p>
<img src="img/280.gif" width="297 px"></img>
</p>
<p>
See if you can solve this programming puzzle, presented in the form of a dialog<br>
between Konstantin Othmer (KON) and Bruce Leak (BAL). The dialog gives clues to<br>
help you. Keep guessing until you're done; your score is the number to the left of the<br>
clue that gave you the correct answer. Even if you never run into the particular<br>
problems being solved here, you'll learn some valuable debugging techniques that will<br>
help you solve your own programming conundrums. And you'll also learn interesting<br>
Macintosh trivia.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;So, BAL, it seems we need to increase our advertising budget to rope in more<br>
guest Puzzle Page authors.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;People don't realize the fame and fortune that comes with being part of the Puzzle<br>
Page. I heard that one person had a lot of good luck shortly after making her first<br>
Puzzle Page submission.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;I heard that another person who thought about submitting a column to the Puzzle<br>
Page, but then decided not to, lost some valuable files.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Enough chain letter tactics. Maybe if we write another column about QuickDraw<br>
or QuickTime, someone will be hungry enough for a change of pace to submit his own<br>
Puzzle Page.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;I figure we should talk about the Internet and then take the Puzzle Page public!<br>
$10 to $12 a share sounds about right to me. Then we can have some serious writing<br>
bounties!
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Maybe we'll change the medium. Instead of printing it, we'll deliver it over TV.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;OK, actually I do have a weird problem. It might be QuickTime-related. I'm<br>
trying to do some video digitizing, but every time I bring up the Video Settings dialog to<br>
choose a compression method, my machine locks up.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Locks up? How? Dead cursor, no MacsBug, the works?
</p>
<p>
<b>100</b><b>KON</b>&nbsp;&nbsp;The cursor is still alive. I can even go into MacsBug and choose Exit to Shell<br>
and everything's fine. But I can't capture video since the dialog just hangs.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;What does the dialog look like when it hangs? Can you click in other<br>
applications?
</p>
<p>
<b>95</b><b>KON</b>&nbsp;&nbsp;The basic structure is there. It draws the outline of the Choose CODEC pop-up<br>
menu, but there's no text. You can click all you want, but no context switch occurs.<br>
You're stuck.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;I've never heard of that before. Why does this stuff always happen to you, KON?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Believe me, I'd love to know the answer to that puzzle!
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;With all your problems, you should write a book on debugging.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Anyway, back to my QuickTime nightmare. Any ideas?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Clearly, that case has worked for millions of people for a long time. Tell me<br>
more. There's probably something funny about your machine.
</p>
<p>
<b>90</b><b>KON</b>&nbsp;&nbsp;I have a Power Macintosh 8100/80. I had an HPV card but then traded<br>
Shannon for his AV card. I tried to buy an AV card, but it's really hard to get one.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;You always have weird hardware and other stuff. What version of the system are<br>
you running? This isn't some beta card again, is it?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;I had version 7.1.2 originally, but as soon as I started having problems with<br>
QuickTime I figured I'd take the opportunity to "upgrade" to System 7.5. All my<br>
hardware is stock Apple stuff. I've written a lot of crazy programs, the results of<br>
many of which have appeared in these pages, but the hardware seems to be kosher.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Which version of 7.5?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;I started with plain 7.5. Then I heard about the fix release, so I upgraded to<br>
7.5.1. I put the project on hold for a while, and heard about a fix for the fix, so I<br>
installed 7.5.2. There was a fix-cubed release, so now I'm running 7.5.3 and it still<br>
happens. Maybe I should wait for 7.5.4?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Come on, KON. Clearly the problem isn't related to a system release. You did a<br>
clean install, right?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Last I heard, the magic incantation was to drag the Finder inside the Preferences<br>
folder, rename the System Folder, jog around your chair three times, and say a<br>
prayer.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Did you sacrifice a frog?
</p>
<p>
<b>85</b><b>KON</b>&nbsp;&nbsp;Seriously, the system install is fine.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;What version of QuickTime is it?
</p>
<p>
<b>80</b><b>KON</b>&nbsp;&nbsp;QuickTime 2.1. That was the latest version I could find. Movies play back OK<br>
-- it's just this capture thing that's giving me fits.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;I guess you've tried replacing QuickTime. Does this happen in other applications<br>
as well?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;I've tried three different applications. Every one has the exact same symptoms:<br>
it locks up when it brings up the Video Settings dialog.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;On one level that makes sense. Applications just call QuickTime to put up that<br>
dialog. But what doesn't make sense is that you have a clean system install, standard<br>
Apple hardware, and the latest QuickTime version, and it hangs. That's crazy. Any<br>
weird extensions or anything?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Nope. Totally clean install.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Swap the hard drive.
</p>
<p>
<b>70</b><b>KON</b>&nbsp;&nbsp;Still happens.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Swap the video card.
</p>
<p>
<b>60</b><b>KON</b>&nbsp;&nbsp;60 and falling fast.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;The monitor?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Let's leave sense-line bugs for a later date. Now that you've swapped out the<br>
whole system except the motherboard, the TV repairman approach is over.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Fine. Give me MacsBug. I'll break into the debugger when the system hangs and<br>
try to figure out what's going on.
</p>
<p>
<b>50</b><b>KON</b>&nbsp;&nbsp;It looks like you're in the Font Manager routine RealFont, which is being<br>
called from a loop in QuickTime. Here's what it looks like:<p class="spacer">&nbsp;</p>
</p>
<pre>Disassembling from 1C5B562
 'CDEF 0064 0F6E'
   +015B2 01C5B562   MOVEQ    #$01,D0                           |7001
   +015B4 01C5B564   MOVE.W   D0,-(A7)                          |3F00
   +015B6 01C5B566   _TextFont                       ; 0019D0E4 |A887
   +015B8 01C5B568   MOVEQ    #$08,D6                           |7C08
   +015BA 01C5B56A   BRA.S    'CDEF 0064 10E6'+015CA ; 01C5B57A |600E
   +015BC 01C5B56C   SUBQ.L   #$2,A7                            |558F
   +015BE 01C5B56E   MOVEQ    #$01,D0                           |7001
   +015C0 01C5B570   MOVE.W   D0,-(A7)                          |3F00
   +015C2 01C5B572   ADDQ.W   #$1,D6                            |5246
   +015C4 01C5B574   MOVE.W   D6,-(A7)                          |3F06
   +015C6 01C5B576   *_RealFont                      ; 408C2B2E |A902
   +015C8 01C5B578   MOVE.B   (A7)+,D7                          |1E1F
   +015CA 01C5B57A   TST.B    D7                                |4A07
   +015CC 01C5B57C   BEQ.S   'CDEF 0064 10E6'+015BC  ; 01C5B56C |67EE
   +015CE 01C5B57E   MOVE.W   D6,-(A7)                          |3F06
   +015D0 01C5B580   _TextSize                       ; 0019D18C |A88A</pre>
<p class="spacer">&nbsp;</p>
<p class="spacer">&nbsp;</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Aha! It's starting to sound a little like a QuickDraw bug to me! What kind of<br>
nastiness did you put in that code, KON?
</p>
<p>
<b>40</b><b>KON</b>&nbsp;&nbsp;Not so quick, pal. RealFont is returning just fine. But the loop calling it<br>
doesn't terminate.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Well, RealFont just tells you whether a particular font size exists. QuickTime<br>
calls RealFont to make sure that the drawing operation in the Video Settings dialog will<br>
look good: if the requested font size doesn't exist, things will scale and look really ugly.<br>
In that case, QuickTime increments the font size and keeps looking.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;OK.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;These dialogs should be drawn with the system font. Is there some strange<br>
problem with your fonts that persists across system installs? I thought I told you to<br>
swap hard drives.
</p>
<p>
<b>30</b><b>KON</b>&nbsp;&nbsp;I did a fresh install on a new hard drive and the problem continued.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Hmm. It sounds like the bug is that QuickTime is searching for a system font size<br>
that won't be scaled -- that is, that's real. It probably expects it to be there. If it's<br>
not, QuickTime spins forever looking.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;OK. So why can't it find it?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;What font are you looking for?
</p>
<p>
<b>20</b><b>KON</b>&nbsp;&nbsp;The font ID passed into RealFont is 1 (AppFont), which RealFont converts<br>
internally to the application font by reading the short at 0x984 (ApFontID).
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;What font is it?
</p>
<p>
<b>KON</b>&nbsp;&nbsp;How do I figure that out?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Call GetFontName. We don't even need to write a program to do this. You can hack<br>
the stack from MacsBug. First, go to some trap call so that you know the proper<br>
registers are saved and all of that. Subtract 6 from the stack. Put the address of where<br>
you want the name to end up at the old stack address, and the fontNum, 1, after that.<br>
Put the address of the GetFontName trap, 0xA8FF, at location 0, set the PC to 0, and<br>
trace.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;You should probably turn off EvenBetterBusError when doing this sort of thing.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Well, yes, that's true. Or, alternatively, we could find a large free block<br>
somewhere and put the code there. Of course, we'd have to be sure the call doesn't move<br>
memory, or our code might be written over -- although for this single trap it doesn't<br>
matter. Anyway, you get the idea.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;The work you'll go through to keep from writing any real code! Wait. Where do I<br>
get the memory for the name?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;You have three choices: you could have subtracted another 255 bytes or so from<br>
the stack and just used that. Better yet is to use some of MacsBug's internal buffer.<br>
When you use the dh command, MacsBug puts the hex data in a buffer and disassembles<br>
it. The address in the disassembly is the address of the MacsBug buffer. Finally, you<br>
could look for a free block with lots of space and use that.
</p>
<p>
<b>10</b><b>KON</b>&nbsp;&nbsp;OK. The font name comes back 0.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;If you trust that, it means there's no font with that fontNum. So it makes sense<br>
that QuickTime would never find a RealFont at any size for that fontNum.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;So why didn't the system install fix it?
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;The system font ID is stored in PRAM and is put in a low-memory global during<br>
startup. Apparently the install process doesn't touch PRAM. Zap your PRAM by holding<br>
Command-Option-Shift-P-R during startup -- user friendly!
</p>
<p>
<b>KON</b>&nbsp;&nbsp;OK. Now it works.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;So the installer should clear PRAM when a new system is installed. It should keep<br>
your video card configuration and other settings, which really belong on the hard disk<br>
as well, but should clear stuff like the default fonts since they may not exist, or they<br>
might be renumbered, in the new install.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;And QuickTime shouldn't spin in an endless loop expecting something to exist.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;PRAM is a holdover from the 128K Macintosh. It was designed as a closed system<br>
that might never have a hard drive. At that time there were only floppies, so it made a<br>
lot of sense to store system parameters with the machine rather than the media. But<br>
since then, no one has ever revisited whether PRAM is needed.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;The machine still has a ROM, for crying out loud! I guess it's too soon to give up<br>
those silly incantations of rebuilding the desktop and zapping PRAM. By the way, I<br>
understand the problem was worked around in QuickTime 2.5 by aborting the font<br>
search loop at a maximum point size of 36.
</p>
<p>
<b>BAL</b>&nbsp;&nbsp;Nasty.
</p>
<p>
<b>KON</b>&nbsp;&nbsp;Yeah.
</p>



<p class="spacer">&nbsp;</p>
<p>
<b>SCORING</b>
</p>
<p><table border="0"><tr><td>90-100 </td><td>Yeah, sure. And you just had lunch with D. B. Cooper.</td></tr>
<tr><td>70-85&nbsp;&nbsp;&nbsp;</td><td>Congratulations! You've just qualified to write the next Puzzle Page.</td></tr>
<tr><td>40-60&nbsp;&nbsp;&nbsp;</td><td>Your spirit guides must be with you today.</td></tr>
<tr><td>10-30&nbsp;&nbsp;&nbsp;</td><td>Care to join our poker game?*</td></tr></table></p>
<p class="spacer">&nbsp;</p>
<p class="spacer">&nbsp;</p>
<p class="spacer">&nbsp;</p>
<p>
<b>KONSTANTIN OTHMER</b> AND <b>BRUCE LEAK</b> dropped off this press release in lieu of<br>
the usual biographical information:
</p>
<p>
PALO ALTO, California, April 1, 1996 -- BalKon Heavy Industries today announced<br>
PuzzleMill (TM), a next-generation, low-cost, networked virtual puzzle architecture<br>
for the World Wide Web, corporate intranets, infinity, and beyond. "Along with our<br>
industry-standard Puzzle Page column, we've set the agenda for digital puzzling into<br>
the next century," said BAL, BalKon's senior vice president for corporate<br>
restructuring. BalKon's executive vice proconsul for corporate misconduct KON will<br>
be acting as grist for the PuzzleMill until a sack of flour can be found to replace him.<br>
KON let spill that the beta version of PuzzleMill can be downloaded free of charge from<br>
http://www.always.balkon.com "until we achieve critical mass, at which point we'll<br>
charge as much as we want for it, darn it."*
</p>
<p>
<b>Thanks to</b> Peter Hoddie, Josh Horwich, and Bo3b Johnson for reviewing this<br>
column.*
</p>
</body>
</html>
