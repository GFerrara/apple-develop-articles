<html>
<head>
<!-- Article ID: 55 - Extracted from develop-1994 -->
<!-- on 2024-05-24 by Giorgio Ferrara - giorgio<dot>ferrara<at>gmail<dot>com -->
<!-- The content is protected by the copyright of its respective owners -->
<title>December 94 - KON & BAL'S PUZZLE PAGE</title>
<link href="../common/styles/main.css" rel="stylesheet" type="text/css">
</head>
<body>
<h2>KON &amp; BAL'S PUZZLE PAGE</h2>
<h2>Processed Cheese</h2>
<h1>CARY CLARK, BYRON, AND SHELLEY</h1>
<p>
<img src="img/259.gif" width="216 px"></img>
</p>
<p>
<i>&nbsp;KON and BAL still lay claim to the Puzzle Page, and they assure us they'll be back, but</i><br>
<i>meanwhile they'd like to have some guest puzzlers take over for a while. (They say</i><br>
<i>they're busy with work at Catapult Entertainment and Rocket Science, but we all know</i><br>
<i>about those vacations they take!) This puzzle is from Cary Clark, presented in the</i><br>
<i>form of a dialog between his astute pug dogs, Shelley and Byron (who, Cary says, will</i><br>
<i>eat anything, including codecs and Texas Hold'ems). The dialog gives clues to help you.</i><br>
<i>Keep guessing until you're done; your score is the number to the left of the clue that</i><br>
<i>gave you the correct answer. And please, help out KON and BAL by submitting puzzles</i><br>
<i>of your own to AppleLink DEVELOP.</i>
</p>
<p>
Shelley KON and BAL have gone the way of the dodo bird (or at least the way of the<br>
hedgehog), so it's time to replace all of their arcane QuickDraw knowledge with arcane<br>
QuickDraw GX knowledge.
</p>
<p>
Byron I tried to use QuickDraw GX, but since installing it off the 1994 WWDC CD, I<br>
can't launch any of my applications.
</p>
<p>
Shelley Are you sure?
</p>
<p>
<b>&nbsp;100</b> Byron Well, the applications launch, but double-clicking a document doesn't do<br>
anything, even though the icons look all right.
</p>
<p>
Shelley The problem is in the desktop database, which the Finder uses to tell which<br>
document file types correspond to which applications. Did you try rebuilding your<br>
desktop?
</p>
<p>
<b>&nbsp;90</b> Byron Sure, but it didn't help.
</p>
<p>
Shelley How about booting off a different disk?
</p>
<p>
<b>&nbsp;85</b> Byron That works, but only for some files. So I removed QuickDraw GX altogether<br>
and rebuilt the original desktop by holding down Option-Command at system startup.<br>
Then everything worked fine.
</p>
<p>
Shelley That must mean that one of the files you removed got rid of the problem.
</p>
<p>
<b>80</b> Byron Nope, grr. I tried explicitly taking the QuickDraw GX extension out of my<br>
Extensions folder and rebooting, and nothing happened, except that my desktop<br>
printers went away.
</p>
<p>
Shelley So how do you like the LQ, anyway?
</p>
<p>
Byron It's a lot faster than the Qume. But I miss watching it hammer the period to<br>
make my LisaDraw pictures.
</p>
<p>
Shelley So, what else is a part of QuickDraw GX? Let's take a peek in the System<br>
Folder. There's the printer drivers, ATM . . .
</p>
<p>
Byron That's never caused any trouble.
</p>
<p>
Shelley . . . ColorSync, the new Color Picker, PrinterShare GX. Hmmm, that's odd --<br>
PrinterShare GX's icon is dimmed as if it were an open application, but it doesn't show<br>
up in the process menu as PrintMonitor used to.
</p>
<p>
<b>75</b> Byron Oh, you dog. That's because PrinterShare's file type is 'appe'. It's a faceless<br>
application that's always running in the background.
</p>
<p>
Shelley I don't remember reading about that in the Processes volume of <i> Inside</i><br>
<i>Macintosh</i> .
</p>
<p>
Byron That's because dogs can't read. But I've heard it's briefly mentioned in Volume VI<br>
on page 9-41. Anyway, that's beside the point. If you type <b> procinfo </b>in MacsBug,<br>
you'll get a list that looks like this:
</p>
<pre> Displaying Process Information
PSN  Process Name        Size     Free     HeapAt   Type Crtr Status
2000 PowerTalk Manager   00044800 00003AE4 05892960 appe kl02 BgOnly
2002 Finder              00026C00 000012DC 05846E80 FNDR MACS Bkgnd
2003 File Sharing Ext... 00029C00 00005A2A 057A2C60 INIT hhgg BgOnly
2005 Eudora 1.4.2        0005CC60 000154F8 057242E0 APPL CSOm Front
2006 NCSA Telnet 2.6     00088000 0003E0B2 056982D0 APPL NCSA Bkgnd
2007 THINK Project Ma... 003E8000 001E1A68 052AC2C0 APPL KAHL Bkgnd
2008 Find File           00046000 00014F4A 052622B0 APPL fndf Bkgnd
200B Microsoft Word      00200000 000C1D5C 0505E2A0 APPL MSWD Bkgnd
200C PrinterShare GX     0001C000 00011488 0503E290 appe PtSr BgOnly</pre>
<p>
&nbsp;Shelley OK, try removing PrinterShare GX and rebuilding the desktop.
</p>
<p>
<b>70</b> Byron Hey, that fixed it!
</p>
<p>
Shelley But the question remains, what's wrong with PrinterShare GX? And how did<br>
you get into this sorry situation anyway?
</p>
<p>
<b>65</b> Byron Well, I ran Norton Utilities on my disk, and it said it was fixing some<br>
applications with bad bundle bits.
</p>
<p>
Shelley So Norton must force the desktop to rebuild in order to register the<br>
applications it thought needed to be reregistered with the Finder's desktop database.<br>
Bad dog. And the Finder fails when rebuilding the desktop.
</p>
<p>
Byron Wait a minute. PowerTalk Manager is also an 'appe'. What's different about it?
</p>
<p>
<b>60</b> Shelley AOCE requires that PowerTalk Manager always run as a background<br>
application, while QuickDraw GX needs PrinterShare GX to run only when a document<br>
is printing.
</p>
<p>
Byron So, how does the system know to run PowerTalk Manager, but not to run<br>
PrinterShare GX?
</p>
<p>
<b>55</b> Shelley PowerTalk Manager contains a resource of type 'appe', ID = 0. This<br>
resource returns true when called as a Pascal function, which tells the Startup<br>
Manager to launch it. PrinterShare GX has no such resource.
</p>
<p>
Byron I bet we could figure this out from the Process Manager source, but barring<br>
that, let's use MacsBug to figure out why the Finder fails.
</p>
<p>
Shelley We can stop on file opens using <b> atb openrf</b> to figure out when the Finder is<br>
accessing PrinterShare GX.
</p>
<p>
Byron But how do you get it to stop only for PrinterShare GX?
</p>
<p>
Shelley Well, I need to find the filename. I put a break on _Open; then I display the<br>
parameter block using <b>dm a0 iopb</b>.
</p>
<p>
Byron<b> iopb</b>?
</p>
<p>
Shelley I/O parameter block. It looks like this:
</p>
<pre> Displaying IOParamBlockRec at 0008D720
0008D720  qLink            NIL
0008D724  qType            0000
0008D726  ioTrap           A000
0008D728  ioCmdAddr        NIL
0008D72C  ioCompletion     NIL
0008D730  ioResult         0000
0008D732  ioNamePtr        0008A8D6 -&gt; "PrinterShare GX"
0008D736  ioVRefNum        FFFF
0008D738  ioRefNum         0000
0008D73A  ioVersNum        #0
0008D73B  ioPermssn        #4
0008D73C  ioMisc           NIL
0008D740  ioBuffer         NIL
0008D744  ioReqCount       00000000
0008D748  ioActCount       00000000
0008D74C  ioPosMode        0000
0008D74E  ioPosOffset      00000000</pre>
<p>
Byron So the 18th byte into the block can be a pointer to a string; we can dereference<br>
that and look for strings that start with 'Prin'.
</p>
<p>
Shelley You C mutt. You have to think Pascal; the first byte will be the string length,<br>
15, so you want to break when<b> @@(a0+12)=0F507269</b>.
</p>
<p>
<b>50</b> Byron By George, this won't work. The file is already open!
</p>
<p>
Shelley How do you know?
</p>
<p>
Byron I used the MacsBug <b> file </b>dcmd, and there it is, near the bottom of the list.
</p>
<pre style="margin-bottom: 0px;">Displaying File Control Blocks</pre>
<code style="font-size:80%;">fRef File&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Type Fl Fork LEof&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mark&nbsp;&nbsp;&nbsp;&nbsp;FlNum&nbsp;&nbsp;Parent FCB at</code><br>
<code style="font-size:80%;">0002 System&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zsys dW rsrc #2303194 #920&nbsp;&nbsp;&nbsp;&nbsp;008359 007bfe 2fb352</code><br>
<code style="font-size:80%;">0060&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**** dw data #1032192 #0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;000003 000000 2fb3b0</code><br>
<code style="font-size:80%;">00be&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**** dw data #3096576 #0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;000004 000000 2fb40e</code><br>
<code style="font-size:80%;">011c Apple Chanc&#8230; fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FFIL dW rsrc #269497&nbsp;&nbsp;#219985 008220 007c02 2fb46c</code><br>
<code style="font-size:80%;">017a Chicago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FFIL dW rsrc #48064&nbsp;&nbsp;&nbsp;#38423&nbsp;&nbsp;008351 007c02 2fb4ca</code><br>
<code style="font-size:80%;">. . .</code><br>
<code style="font-size:80%;">0874 PowerTalk M&#8230; fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appe dW rsrc #507556&nbsp;&nbsp;#413184 007ca8 007bff 2fbbc4</code><br>
<code style="font-size:80%;">08d2 PrinterShar&#8230; fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appe dW rsrc #32978&nbsp;&nbsp;&nbsp;#708&nbsp;&nbsp;&nbsp;&nbsp;008236 007bff 2fbb22</code><br>
<code style="font-size:80%;">0930 Finder&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FNDR dW rsrc #456553&nbsp;&nbsp;#362328 00835c 007bfe 2fbc80</code><br>
<code style="font-size:80%;">098e Finder Pref&#8230; fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pref dW rsrc #19983&nbsp;&nbsp;&nbsp;#328&nbsp;&nbsp;&nbsp;&nbsp;007cde 007c95 2fbcde</code><br>
<code style="font-size:80%;">09ec Desktop DB&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BTFL dW data #196608&nbsp;&nbsp;#150528 000011 000002 2fbd3c</code><br>
<code style="font-size:80%;">0a4a Desktop DF&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DTFL dW data #351810&nbsp;&nbsp;#101184 000010 000002 2fbd9a</code><br>
<code style="font-size:80%;">0bc2 QMgrCatalog&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BTFL dW data #65536&nbsp;&nbsp;&nbsp;#1024&nbsp;&nbsp;&nbsp;007ce5 007ce4 2fbf12</code><br>
<code style="font-size:80%;">0c20 WSBTree&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BTFL dW data #65536&nbsp;&nbsp;&nbsp;#1024&nbsp;&nbsp;&nbsp;007ce7 007ce2 2fbf70</code><br>
<code style="font-size:80%;">131a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mail En&#8230; **** dw data #0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;000003 000000 2fc66a</code><br>
<pre style="margin-top: 0px;">#74 FCBs, #35 in use, #39 free</pre>
<p>
<b>45</b> Shelley That could be OK. It depends on whether the Finder is opening a read-only<br>
path on the file. We can tell by looking at the parameter block as we did before and<br>
seeing what's in the ioPermssn field.
</p>
<p>
<b>40</b> Byron As I suspected, it's a 3, meaning the Finder is opening it for reading and<br>
writing, when it only needs to read the bundle resource.
</p>
<p>
<b>35</b> Shelley Well, not exactly, since it wants to mark the file as initialized, so that<br>
next time it won't add the file to the database again.
</p>
<p>
Byron But isn't that data in the Finder info, which is in neither the data fork nor the<br>
resource fork, but just part of the file identifier, like the filename?
</p>
<p>
<b>30</b> Shelley Oh, yeah. I know! The standard call OpenResFile always tries for<br>
read/write permission. The Finder desktop-building code is old and tired, but I'm sure<br>
when they rewrite it they'll correctly use OpenRF instead. In any case, the Finder is<br>
getting an error it doesn't expect when opening the file, so it gives up building the<br>
desktop database before it has retrieved the bundle information from all of the<br>
applications.
</p>
<p>
<b>25</b> Byron So one possible fix is to prevent the Startup Manager from opening the file<br>
in the first place, since QuickDraw GX doesn't need it to be open all the time.
</p>
<p>
<b>20</b> Shelley Or we could cause the file to be opened as read-only by setting its shared<br>
bundle bit. There's a more obscure way to solve the problem: if we put the right stuff<br>
in the 'appe' resource, the Startup Manager will be instructed to close the file after<br>
executing some code.
</p>
<p>
<b>15</b> Byron I happen to have a copy of ResEdit right here. It's a little difficult to work<br>
with my paws, so give me a minute. Hey -- look at that little man going in and out of<br>
the jack- in-the-box. I could watch this all&nbsp;&nbsp;day!
</p>
<p>
Shelley Cool. It even changes all the colors in the system palette, causing all of the<br>
screens to redraw, and then redraw again when you quit. State of the art, man -- I<br>
mean, dog.
</p>
<p>
<b>10</b> Byron Well, the problem is now obvious. PrinterShare GX is a background<br>
application that doesn't need to run all the time, but it doesn't have the shared bit set,<br>
and it doesn't have an 'appe' resource. The 'appe' resource is code, and I don't have that<br>
nifty ResEdit code editor.
</p>
<p>
<b>5</b> Shelley We can use MacsBug to write it for us. All we need are enough instructions<br>
to create a Pascal function that returns false. We can cheat by disassembling PtInRect<br>
and steal a little code from there. We can verify our code by using the MacsBug<br>
command <b> dh </b>to disassemble our hex. I think <b>422e 0004 4e74 0004</b> ought to do<br>
the trick.
</p>
<p>
Byron What does that do?
</p>
<p>
Shelley It causes an illegal instruction error on a 68000 machine. Good thing Apple<br>
doesn't sell those anymore.
</p>
<p>
Byron But I just bought a luggable for a steal at the flea market! What can I do?
</p>
<p>
Shelley Hit your smushed-faced little head against it. QuickDraw GX runs only on<br>
68020 and better, so this code is just fine.
</p>
<p>
Byron Arf.
</p>
<p>
Shelley Grr.
</p>
<p>
<b>SCORING</b>
</p>
<ul>
<li>80-100 Excellent! You're good enough to write your own puzzles. Heck,<br>
you could probably write the whole <i> develop</i>&nbsp;&nbsp;magazine. (While you're at it,<br>
try to get some work out of those slackers at Catapult Entertainment and<br>
Rocket Science.)</li>
<li>55-75 Pretty good. You could speed up the blits in QuickDraw GX. (When<br>
you do, let us know.)</li>
<li>30-50 Not bad. You could make the PostScript driver go fast even without<br>
taking it native.</li>
<li>5-25 Try not to hurt yourself with shape operations. *</li>
</ul>
<p>
<b>CARY CLARK</b>, once on the QuickDraw GX engineering team at Apple, has joined BAL at<br>
Rocket Science. He's co-owner of Shelley and Byron, who often know more than he<br>
does. Cary was working on QuickDraw when BAL made Microsoft Word skanky and KON<br>
made GM (not General Magic) what it is today. Next time you see KON, ask him if he<br>
wants to cut for a hundred and watch him wince. *
</p>
<p>
<b>Thanks </b>to Dave Hersey, KON (Konstantin Othmer), and BAL (Bruce Leak) for<br>
reviewing this column, and to Ron Voss for tracking the problem down and fixing it in<br>
the shipping version of QuickDraw GX. *
</p>
</body>
</html>
