<!DOCTYPE html>
<html>
<head>
<!-- Article ID: 41 - Extracted from develop-1995 -->
<!-- on 2024-08-30 by Giorgio Ferrara - giorgio<dot>ferrara<at>gmail<dot>com -->
<!-- The content is protected by the copyright of its respective owners -->
<title>September 95 - KON & BAL's Puzzle Page: Video Nightmare</title>
<link href="../common/styles/main.css" rel="stylesheet" type="text/css">
</head>
<body>
<h1>KON &amp; BAL's Puzzle Page: Video Nightmare</h1>
<h2>Ian Hendry and Eric Anderson</h2>
<p>
<img src="img/209.gif" width="290 px"></img>
</p>
<p>
<i>See if you can solve this programming puzzle, presented in the form of a dialog</i><br>
<i>between a pseudo KON (Ian Hendry) and BAL (Eric Anderson). The dialog gives clues to</i><br>
<i>help you. Keep guessing until you're done; your score is the number to the left of the</i><br>
<i>clue that gave you the correct answer. Even if you never run into the particular</i><br>
<i>problems being solved here, you'll learn some valuable debugging techniques that will</i><br>
<i>help you solve your own programming conundrums. And you'll also learn interesting</i><br>
<i>Macintosh trivia.</i>
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I've got one for you, KON: I just updated to System 7.5 on my 8100/80 AV.<br>
Everything seemed OK for a while. I was comparing Scenery Animator to Vistapro and I<br>
noticed that my cool new desktop pattern had disappeared. It was there when I booted,<br>
but just as the Finder was coming up, the desktop changed to a black-and-white<br>
pattern.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;That's easy. Go back to System 7.1 and the world will be fine again. Next.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hey, 7.5 is the source of much wonderment. It's really a lot of fun!
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I don't know that much about 7.5. Metrowerks and THINK C seem to run fine on<br>
7.1. Is this part of that new puzzle CDEV that was added to spruce up the system?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quit trying to change the subject. My desktop pattern went away and I'm not<br>
happy about it.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hmm. Did you change anything on your machine?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I turned on VM for the memory-hungry rendering stuff.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So turn off VM and see if the problem goes away.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wow, that worked great. Now all I have to do is buy $1800 worth of<br>
tariff-enhanced RAM so I can render my flyby of the Pentagon.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I won't ask what you're up to these days. My recent stock dealings have left me<br>
low on bail money. Did you try it on 7.1.2?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It didn't happen on straight 7.1.2, but I installed System Update 3.0 and it<br>
happened. VM must have changed in this update.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sounds like a VM problem all right. Paste the older VM resources into the new<br>
system. (I love component software.)
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The problem is still there. Does this let VM off the hook?
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM is never off the hook, but if your only problem is that the desktop pattern is<br>
black and white, maybe you should stop whining and do your work.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No, this is more serious. I opened the Monitors control panel and there was no<br>
depth list and no monitor tile in the rearrange section.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Well, this should be pretty straightforward. Does it happen every time?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No such luck. This one is really evil. I've been trying to get a reproducible case<br>
for days. Sometimes it happens right away, sometimes it goes away for hours. Once it<br>
starts happening, it seems to keep happening across restarts. It doesn't happen as<br>
reliably across shutdowns. It seems to happen more in millions of colors but will<br>
happen at other depths too. Switching the display back and forth between a 13-inch and<br>
a multiple-scan display sometimes causes the problem to show up. Changing VM and<br>
RAM disk settings seems to affect the reproducibility.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cool! The random bugs are always the most fun. Let's get our trusty MacsBug<br>
and see if we can find where it's going bad. Look at the video driver and GDevice.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When I try to enter MacsBug, the mouse freezes but MacsBug doesn't come up.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dang, I hate it when the tools don't work.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Perhaps we should devote this column to model rocketry and video games<br>
instead.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Now there's a thought. If I type Command-G, does the mouse unfreeze, or do I<br>
have to reboot?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The machine comes back when you hit Command-G.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So MacsBug is there; you just can't see it. I'll use log foo to dump the output to a<br>
file named foo, followed by
</p>
<p>
dm @@thegdevice gdevice
</p>
<p>
Then I'll use drvr to see if the video driver is alive.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nice log trick, KON! The GDevice is fine, and the driver looks as if it's loaded<br>
and active.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Drivers and VM sometimes don't get along. Maybe the driver is doing something<br>
wrong. Did you try other video cards?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It seems to happen only on Power Macintosh AV models.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It's the nasty "fungus" problem from Issue 17 all over again, or maybe your<br>
card has gone bad.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Well, I'm pretty sure there was no "fungus" around when the AV card was<br>
developed, so it's probably not that. Besides, we're sticking to production software in<br>
this column from now on. Anyway, I thought it might be my card, too, so I borrowed<br>
your card. Thanks for the loaner. I turned on VM and it worked like a champ . . . for a<br>
while. Now I've got the same problem again.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You killed my card?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Admittedly, it's a computer that can do anything. But for the purposes of this<br>
column, that idea is pretty far-fetched.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Here's what might be happening: Early in the boot process, VM isn't present.<br>
For each card, the system calls the card's PrimaryInit code and creates a GDevice.<br>
When VM loads, it changes the logical address mappings. When the driver is called<br>
again, it assumes a one-to-one logical-to-physical mapping of RAM, so the card starts<br>
responding to bogus address cycles. This confuses the card's bus translator, and . . .
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Whatever. Any other stabs in the dark? Lose five points and try again.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OK. Perhaps there are subtle timing variations when VM is present, and the<br>
video card might have borderline hardware that's affected by these timing<br>
dependencies. Or maybe the card's controller gets into a state where it no longer<br>
responds to its address space.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You're getting desperate. It's not a hardware problem. The declaration ROM is<br>
there and everything looks fine. You can't blame this on the hardware. Let's once again<br>
follow the software decision tree.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yeah, you're probably right. Now that I think about it, those ideas seem really<br>
out there.
</p>
<p>
So what you're telling me is that the desktop pattern is black and white, MacsBug isn't<br>
working, and the Monitors control panel doesn't show depths or a monitor tile. Let's<br>
find out when MacsBug stops working.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When the machine boots, MacsBug is working, but by the time you get to the<br>
Finder, it's gone. It seems to vanish early in the boot process.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See if you get to the first Display Manager call with an atb DisplayDispatch or<br>
atb ABEB.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OK. MacsBug is still alive.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I'll set a breakpoint just after the first Display Manager call and then go.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yep. There doesn't seem to be a problem now. But the weird thing is, if you<br>
trace over the Display Manager call and then type go, MacsBug will eventually go away.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wacky. Sounds like a Display Manager bug.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Earlier you said it was a VM bug.
</p>
<p>
&nbsp;&nbsp;&nbsp;&nbsp;KON Both have been convicted criminals in the past, so you can't blame me for<br>
thinking they're suspects. I'll bet you a buck it turns out to be neither! Do an atb on<br>
the Display Manager call and trace from there until MacsBug goes away; it shouldn't<br>
take too long.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sorry, MacsBug never goes away. The problem isn't reproduced.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So what you're telling me is that if I trace over the Display Manager call and<br>
then go, I can't get into MacsBug after I'm done booting. But if I keep tracing, the<br>
machine boots fine and MacsBug is always available.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;That's right. Let me help you along a little bit. There's an SSecondaryInit call<br>
(which runs SecondaryInit code for the video cards) just a few 680x0 instructions<br>
after the first Display Manager call. Does that help at all?
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;What happens if we do an atb on SSecondaryInit?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I can't reproduce the problem. If I set a breakpoint just after the Display<br>
Manager call and go, the problem disappears. If I do an atb on the Display Manager call,<br>
and either go from there or trace over it and go, the problem happens. If I trace over it<br>
for a few instructions and go, the problem doesn't happen.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So, what are the "few" instructions? It looks like they're the ones whacking the<br>
video driver.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No, they're just a few MOVE instructions to innocuous RAM locations -- nothing<br>
that should touch video.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;What does this Display Manager call do? Could it be hosing anything in the<br>
slots?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I don't think so. I used MacsBug to skip it entirely and the problem still<br>
happens.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This isn't getting us anywhere. Maybe the desktop pattern problem has some<br>
better clues. The General Controls control panel in System 7.5 has an INIT resource<br>
that calls HasDepth to decide whether to use the color pattern. It then sets a PRAM bit<br>
to remember whether to use a color pattern across restarts. When the desktop pattern<br>
is black and white, I'll use the log trick to find out what the HasDepth call is returning.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It returns an error.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aha! Since HasDepth returns an error, the INIT resource thinks it's on a<br>
display that can support only one bit per pixel (black and white), so it disables the<br>
color desktop pattern and resets the PRAM bit; the color desktop pattern is now gone<br>
forever.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OK.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Let's trace HasDepth and find out what's wrong.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It looks as if the Slot Manager returns the correct values for the active<br>
functional sResource of the card but fails to find the depth. It returns -316, an<br>
smInitStatVErr. According to Errors.h, this error indicates that the siInitStatusV field<br>
was "negative after primary or secondary init." This means the card's PrimaryInit or<br>
SecondaryInit code returned an error.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We can bet it's not PrimaryInit, because the GDevice is good. If the error had<br>
happened in PrimaryInit, QuickDraw would have gotten an smInitStatVErr when it<br>
called the Slot Manager to build the GDevice.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You're finally making some progress!
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MacsBug also makes Slot Manager calls (when it tries to switch depths), which<br>
explains why it fails. That means the problem must be with the SSecondaryInit call.<br>
Once the Slot Manager gets this error, most Slot Manager calls return errors.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;But this doesn't explain what's causing the Slot Manager to fail to begin with, or<br>
why the problem goes away every time we get close to it with MacsBug.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe we should try this with a BootBug card. Can you still get one?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe, but we're doing pretty well here. Let's keep going a little longer.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Let's try to figure it out by brute logic. What does the SecondaryInit code look<br>
like on this card?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MOVE.L A0,A0.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;That's it? Two bytes? No RTS? Cool! A bug in the AV card ROM! Does this mean<br>
we all get new cards with the new 2.0 ROM? Maybe they can simplify that complicated<br>
Monitors control panel Options dialog at the same time. How does it boot at all?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Good question. <i>Designing Cards and Drivers for the Macintosh Family</i>says that<br>
the SecondaryInit entry on a video card is an SExecBlock, which is a header followed by<br>
actual code. The Slot Manager validates the header before it executes the code. The first<br>
byte of an SExecBlock is the revision number, and the Slot Manager checks for a<br>
revision byte of 0x02. Since MOVE.L A0,A0 is 0x2048 in hex, the first byte of the AV<br>
card's SecondaryInit entry is 0x20, which is a bogus entry, and the Slot Manager will<br>
never try to execute the SecondaryInit code.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So it's pretty lame, but it should work, right?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yes. Remember, we added SecondaryInit to the boot process because some<br>
machines didn't have 32-bit QuickDraw in ROM. On a machine without 32-bit<br>
QuickDraw in ROM, video cards have to disable their functional sResources with direct<br>
bit depths (16 and 32) in their PrimaryInit code, because the PrimaryInit code runs<br>
before the disk is up and the cards can't tell if the system has 32-bit QuickDraw<br>
installed. SecondaryInit was added to give these cards a chance to reenable those direct<br>
depths after 32-bit QuickDraw was loaded from disk. Power Macs obviously have<br>
32-bit QuickDraw in ROM, and this card only runs on a Power Mac, so it doesn't need<br>
SecondaryInit.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Let's walk through the SSecondaryInit call and see what it does. Why does VM<br>
make a difference? And why is MacsBug causing the problem to go away if you set<br>
breakpoints?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You're just full of questions, aren't you? You're supposed to be giving the<br>
answers!
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Let's walk through SSecondaryInit.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For each card, it looks for a SecondaryInit entry in the card's ROM. The entry<br>
contains a header followed by the SecondaryInit code. If there's no SecondaryInit entry<br>
on the card, SSecondaryInit bails out early. If there is a SecondaryInit on the card, the<br>
Slot Manager tries to execute it with SExec and then checks the status from the SExec<br>
call. If the status is negative (an error), the Slot Manager marks the slot with that<br>
evil -316 error, and the slot is bad from there on out.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So who is responsible for setting the error?
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The code executed by SExec, in this case the SecondaryInit code, should set the<br>
status error. If the header is bad, the code never gets run and the status never gets set.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Let me guess: the boot code never initializes the status before calling SExec.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yep. And it's allocated on the stack as a local variable, which means that the<br>
status is set to whatever garbage is left on the stack. At this point in the boot process<br>
you're still in supervisor mode, so MacsBug is sharing your stack. When MacsBug is<br>
used, it pushes stuff onto the stack and then pops it off when it leaves (changing the<br>
garbage below the stack in the process). That's why setting breakpoints and tracing<br>
mask the problem. BootBug also uses the stack, so it too would have interfered with the<br>
bug.
</p>
<p>
Between the first Display Manager call and the SSecondaryInit, the system allocates<br>
stack space for the SPBlock parameter for the SSecondaryInit call. After the SPBlock<br>
is allocated, the stack pointer is very close to where the local variables for<br>
SSecondaryInit will be allocated. At this point MacsBug's stack usage will affect those<br>
never-initialized local variables.
</p>
<p>
This is something else to add to your list of gotchas for MacsBug: If you're in<br>
supervisor mode (as you are at this point in the boot process) and you set breakpoints,<br>
MacsBug is sharing your stack, and its use of the stack may affect uninitialized<br>
variables. Later in the boot process, VM switches the machine to user mode; from then<br>
on, MacsBug and applications use different stacks and MacsBug will not interfere with<br>
uninitialized variables on the stack.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The garbage that VM leaves on the stack (sometimes) happens to be negative.<br>
When the boot code gets to SecondaryInit and allocates variables on the stack, it<br>
happens to use an area of the stack affected by VM.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Well, I never turn VM on, so I'm always in supervisor mode, and MacsBug<br>
always shares my stack. But now I've finally found a good use for VM: turn it on when I<br>
have a bug that's hard to reproduce when MacsBug gets involved, and see if it becomes<br>
reproducible.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;That'll slow your machine down.
</p>
<p>
BAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nasty.
</p>
<p>
KON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Yeah.
</p>



<p>
<b>SCORING</b>
</p>
<p>
75-100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Excellent; you probably have a video-in jack built right into your head.
</p>
<p>
50-70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe we should be working for you.
</p>
<p>
25-45&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe you should be working for us.
</p>
<p>
5-20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe you should stick to television.*
</p>
<p>
Thanks to Rich Collyer, Kent Miller, Mike Puckett, John Yen, KON (Konstantin<br>
Othmer), and BAL (Bruce Leak) for reviewing this column.*
</p>
<p>
<b>IAN HENDRY</b> (AppleLink HENDRY; Internet hendry@apple.com) gets paid by Apple to<br>
work on video stuff. His hobbies include shipping products and collecting new<br>
Engineering managers. He can be found skipping meetings to play Ultimate and working<br>
all hours to make up for it. Ian's going to be a dad soon, and though he has been in<br>
rigorous sleep-deprivation training for years, he's hoping (but still not certain) that<br>
he's ready for what he's gotten himself into.*
</p>
<p>
<b>ERIC ANDERSON</b> (AppleLink ERIC3) skipped out on the OS Services group at Apple<br>
to get away from the chore of working on VM and the Thread Manager. Now he works as<br>
Ian's evil twin on video-related Mac OS issues -- and he gets bugs assigned to him that<br>
state, "When using a multisync monitor with my threaded test app while VM is on, this<br>
funny thing happens." Seeing that there's no escape, Eric wants more than ever to<br>
move to Hawaii and build boats.*
</p>
</body>
</html>
